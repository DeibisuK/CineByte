<div class="main-content">
    <div class="content-wrapper">
        <div class="page-header">
            <button class="btn btn-primary" routerLink="/admin/peliculas/list"
                style="height: 50px; background: linear-gradient(135deg, #FFD700, #FFA500); border: none;">
                <a class="text-white" style="text-decoration: none;">
                    <i class="fa-solid fa-arrow-left"></i> Volver
                </a>
            </button>
            <h2>Agregar Nueva Película</h2>
        </div>

        <div class="form-container">
            <form [formGroup]="peliculaForm" (ngSubmit)="onSubmit()" class="form-grid">

                <div class="image-upload-section">
                    <label class="image-upload">
                        <input type="file" accept="image/*" (change)="onImageSelected($event)" style="display: none;">
                        <ng-container *ngIf="imagenPreview; else uploadIcon">
                            <img [src]="imagenPreview" alt="Vista previa" class="img-preview" />
                        </ng-container>
                        <ng-template #uploadIcon>
                            <i class="fa-solid fa-plus"></i>
                            <div class="text">Agregar Imagen</div>
                        </ng-template>
                    </label>
                </div>

                <div class="form-fields">
                    <div class="form-field">
                        <label for="titulo">Título</label>
                        <input type="text" id="titulo" formControlName="titulo"
                            placeholder="Ingrese el título de la película">
                        <div *ngIf="peliculaForm.get('titulo')?.invalid && peliculaForm.get('titulo')?.touched"
                            class="validation-error">
                            El título es obligatorio.
                        </div>
                    </div>

                    <div class="field-row-three">
                        <div class="form-field">
                            <label for="fecha_estreno">Fecha de Estreno</label>
                            <input type="date" id="fecha_estreno" formControlName="fecha_estreno" required>
                            <div *ngIf="peliculaForm.get('fecha_estreno')?.invalid && peliculaForm.get('fecha_estreno')?.touched"
                                class="validation-error">
                                La fecha de estreno es obligatoria.
                            </div>
                        </div>
                        <div class="form-field">
                            <label for="duracion_minutos">Duración</label>
                            <input type="number" id="duracion_minutos" formControlName="duracion_minutos"
                                class="duracion-input" placeholder="120 min." min="1" required>
                            <div *ngIf="peliculaForm.get('duracion_minutos')?.invalid && peliculaForm.get('duracion_minutos')?.touched"
                                class="validation-error">
                                La duración es obligatoria y debe ser un número positivo.
                            </div>

                        </div>
                        <div class="form-field">
                            <label for="clasificacion">Clasificación</label>
                            <select id="clasificacion" formControlName="clasificacion" required>
                                <option value="">Seleccione una clasificación</option>
                                <option *ngFor="let clasificacion of clasificaciones" [value]="clasificacion">
                                    {{ clasificacion }}
                                </option>
                            </select>
                            <div *ngIf="peliculaForm.get('clasificacion')?.invalid && peliculaForm.get('clasificacion')?.touched"
                                class="validation-error">
                                La clasificación es obligatoria.
                            </div>
                        </div>
                    </div>

                    <div class="form-field">
                        <label for="descripcion">Descripción</label>
                        <textarea id="descripcion" formControlName="descripcion"
                            placeholder="Ingrese una descripción detallada de la película..." required></textarea>
                        <div *ngIf="peliculaForm.get('descripcion')?.invalid && peliculaForm.get('descripcion')?.touched"
                            class="validation-error">
                            La descripción es obligatoria.
                        </div>
                    </div>

                    <div class="field-row-two">
                        <div class="form-field">
                            <label for="idiomas">Idiomas</label>
                            <div class="search-select-container">
                <input type="text" 
                       class="search-input" 
                       placeholder="Buscar idiomas..."
                       [(ngModel)]="idiomasSearchTerm"
                       (input)="filterIdiomas($event)"
                       (focus)="showIdiomasDropdown = true"
                       (blur)="onIdiomasBlur()">
                                <i class="fas fa-chevron-down search-arrow" [class.open]="showIdiomasDropdown"></i>
                                <div class="search-dropdown" [class.show]="showIdiomasDropdown && filteredIdiomas.length > 0">
                                    <div *ngFor="let idioma of filteredIdiomas" 
                                         class="dropdown-item"
                                         (click)="selectIdioma(idioma)">
                                        {{ idioma.nombre }}
                                    </div>
                                </div>
                                <div *ngIf="showIdiomasDropdown && filteredIdiomas.length === 0 && idiomasSearchTerm.trim() !== ''" 
                                     class="no-results">
                                    No se encontraron idiomas
                                </div>
                            </div>
                        </div>

                        <div class="form-field">
                            <label for="generos">Géneros</label>
                            <div class="search-select-container">
                <input type="text" 
                       class="search-input" 
                       placeholder="Buscar géneros..."
                       [(ngModel)]="generosSearchTerm"
                       (input)="filterGeneros($event)"
                       (focus)="showGenerosDropdown = true"
                       (blur)="onGenerosBlur()">
                                <i class="fas fa-chevron-down search-arrow" [class.open]="showGenerosDropdown"></i>
                                <div class="search-dropdown" [class.show]="showGenerosDropdown && filteredGeneros.length > 0">
                                    <div *ngFor="let genero of filteredGeneros" 
                                         class="dropdown-item"
                                         (click)="selectGenero(genero)">
                                        {{ genero.nombre }}
                                    </div>
                                </div>
                                <div *ngIf="showGenerosDropdown && filteredGeneros.length === 0 && generosSearchTerm.trim() !== ''" 
                                     class="no-results">
                                    No se encontraron géneros
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="field-row-two">
                        <div class="multi-select">
                            <label>Idiomas Seleccionados</label>
                            <div class="tags-container" [class.has-tags]="selectedIdiomas.length > 0">
                                <div *ngIf="selectedIdiomas.length === 0" class="empty-state">
                                    No hay idiomas seleccionados
                                </div>
                                <div *ngFor="let idioma of selectedIdiomas" class="tag">
                                    {{ idioma.nombre }}
                                    <span class="tag-remove" (click)="removeIdioma(idioma)">×</span>
                                </div>
                            </div>
                        </div>
                        <div class="multi-select">
                            <label>Géneros Seleccionados</label>
                            <div class="tags-container" [class.has-tags]="selectedGenres.length > 0">
                                <div *ngIf="selectedGenres.length === 0" class="empty-state">
                                    No hay géneros seleccionados
                                </div>
                                <div *ngFor="let genero of selectedGenres" class="tag">
                                    {{ genero.nombre }}
                                    <span class="tag-remove" (click)="removeGenre(genero)">×</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="field-row-two">
                        <div class="form-field">
                            <label for="actores">Actores</label>
                            <div class="search-select-container">
                <input type="text" 
                       class="search-input" 
                       placeholder="Buscar actores..."
                       [(ngModel)]="actoresSearchTerm"
                       (input)="filterActores($event)"
                       (focus)="showActoresDropdown = true"
                       (blur)="onActoresBlur()">
                                <i class="fas fa-chevron-down search-arrow" [class.open]="showActoresDropdown"></i>
                                <div class="search-dropdown" [class.show]="showActoresDropdown && filteredActores.length > 0">
                                    <div *ngFor="let actor of filteredActores" 
                                         class="dropdown-item"
                                         (click)="selectActor(actor)">
                                        {{ actor.nombre }} {{ actor.apellidos }}
                                    </div>
                                </div>
                                <div *ngIf="showActoresDropdown && filteredActores.length === 0 && actoresSearchTerm.trim() !== ''" 
                                     class="no-results">
                                    No se encontraron actores
                                </div>
                                <button type="button" class="add-new-btn" (click)="abrirModal('actor')">
                                    <i class="fa-solid fa-plus"></i> Nuevo Actor
                                </button>
                            </div>
                        </div>

                        <div class="form-field">
                            <label for="etiquetas">Etiquetas</label>
                            <div class="search-select-container">
                <input type="text" 
                       class="search-input" 
                       placeholder="Buscar etiquetas..."
                       [(ngModel)]="etiquetasSearchTerm"
                       (input)="filterEtiquetas($event)"
                       (focus)="showEtiquetasDropdown = true"
                       (blur)="onEtiquetasBlur()">
                                <i class="fas fa-chevron-down search-arrow" [class.open]="showEtiquetasDropdown"></i>
                                <div class="search-dropdown" [class.show]="showEtiquetasDropdown && filteredEtiquetas.length > 0">
                                    <div *ngFor="let etiqueta of filteredEtiquetas" 
                                         class="dropdown-item"
                                         (click)="selectEtiqueta(etiqueta)">
                                        {{ etiqueta.nombre }}
                                    </div>
                                </div>
                                <div *ngIf="showEtiquetasDropdown && filteredEtiquetas.length === 0 && etiquetasSearchTerm.trim() !== ''" 
                                     class="no-results">
                                    No se encontraron etiquetas
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="field-row-two">
                        <div class="multi-select">
                            <label>Actores Seleccionados</label>
                            <div class="tags-container" [class.has-tags]="selectedActores.length > 0">
                                <div *ngIf="selectedActores.length === 0" class="empty-state">
                                    No hay actores seleccionados
                                </div>
                                <div *ngFor="let actor of selectedActores" class="tag">
                                    {{ actor.nombre }} {{ actor.apellidos }}
                                    <span class="tag-remove" (click)="removeActor(actor)">×</span>
                                </div>
                            </div>
                        </div>

                        <div class="multi-select">
                            <label>Etiquetas Seleccionadas</label>
                            <div class="tags-container" [class.has-tags]="selectedTags.length > 0">
                                <div *ngIf="selectedTags.length === 0" class="empty-state">
                                    No hay etiquetas seleccionadas
                                </div>
                                <div *ngFor="let etiqueta of selectedTags" class="tag">
                                    {{ etiqueta.nombre }}
                                    <span class="tag-remove" (click)="removeTag(etiqueta)">×</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="field-row-two">
                        <div class="form-field">
                            <label for="id_distribuidor">Distribuidor</label>
                            <div class="search-select-container">
                                <input type="text" 
                                       class="search-input" 
                                       placeholder="Buscar distribuidor..."
                                       [(ngModel)]="distribuidorSearchTerm"
                                       (input)="filterDistribuidores($event)"
                                       (focus)="showDistribuidorDropdown = true"
                                       (blur)="onDistribuidorBlur()">
                                <i class="fas fa-chevron-down search-arrow" [class.open]="showDistribuidorDropdown"></i>
                                <div class="search-dropdown" [class.show]="showDistribuidorDropdown && filteredDistribuidores.length > 0">
                                    <div *ngFor="let distri of filteredDistribuidores" 
                                         class="dropdown-item"
                                         (click)="selectDistribuidor(distri)">
                                        {{ distri.nombre }}
                                    </div>
                                </div>
                                <div *ngIf="showDistribuidorDropdown && filteredDistribuidores.length === 0 && distribuidorSearchTerm.trim() !== ''" 
                                     class="no-results">
                                    No se encontraron distribuidores
                                </div>
                                <button type="button" class="add-new-btn" (click)="abrirModal('distribuidor')">
                                    <i class="fa-solid fa-plus"></i> Nuevo Distribuidor
                                </button>
                            </div>
                            <div class="selected-distribuidor" *ngIf="selectedDistribuidor" style="margin-top: 10px;">
                                <span class="selected-tag">
                                    {{ selectedDistribuidor.nombre }}
                                    <button type="button" class="remove-tag" (click)="removeDistribuidor()">×</button>
                                </span>
                            </div>
                        </div>

                        <div class="form-field">
                            <label for="estado">Estado</label>
                            <select id="estado" formControlName="estado">
                                <option value="">Seleccione un estado</option>
                                <option value="activo">Estreno</option>
                                <option value="proximamente">Próximamente</option>
                                <option value="retirada">Retirada</option>
                            </select>
                        </div>
                    </div>


                    <div class="adicionales-section">
                        <label class="adicionales-label">Imágenes Adicionales (máx. 5)</label>

                        <!-- Carrusel de imágenes adicionales -->
                        <div class="carousel-wrapper">
                            <button class="carousel-nav left" (click)="navigateCarousel(-1)" type="button"
                                [disabled]="!canNavigateLeft()">
                                <i class="fa-solid fa-chevron-left"></i>
                            </button>

                            <div class="carousel-container">
                                <div class="carousel-track"
                                    [style.transform]="'translateX(' + getCarouselOffset() + 'px)'">
                                    <!-- Imágenes subidas -->
                                    <div class="carousel-slide"
                                        *ngFor="let imagen of imagenesAdicionales; let i = index">
                                        <img [src]="imagen.preview" [alt]="'Imagen ' + (i + 1)">
                                        <button class="delete-btn" (click)="removeImage(i)" type="button">×</button>
                                    </div>

                                    <!-- Botón para agregar nueva imagen -->
                                    <div class="carousel-slide add-slide" *ngIf="imagenesAdicionales.length < 5">
                                        <label class="upload-label">
                                            <input type="file" (change)="onAdicionalImageSelected($event)"
                                                accept="image/*" style="display: none;">
                                            <i class="fa-solid fa-plus"></i>
                                            <span>Agregar Imagen</span>
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <button class="carousel-nav right" (click)="navigateCarousel(1)" type="button"
                                [disabled]="!canNavigateRight()">
                                <i class="fa-solid fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>

                </div>
                <div class="submit-section">
                    <button type="submit" class="submit-btn">
                        Crear Película
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>




<div class="modal-global-container">
    <app-crear-actor [mostrar]="mostrarModalActor" (cerrar)="cerrarModal('actor')"></app-crear-actor>
    <app-crear-distribuidor [mostrar]="mostrarModalDistribuidor"
        (cerrar)="cerrarModal('distribuidor')"></app-crear-distribuidor>
</div>